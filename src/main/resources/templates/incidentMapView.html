<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Traffic Incidents</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        .navbar {
            background-color: #333;
            overflow: hidden;
        }

        .navbar a {
            float: left;
            display: block;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 17px;
        }

        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }

        .navbar a.active {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
<h1>Tampere Traffic App</h1>
<nav class="navbar">
    <a href="/camera/map">Traffic Cameras</a>
    <a href="/incident/map" class="active">Traffic Incidents</a>
</nav>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var situationRecords = /*[[${situationRecords}]]*/ [];

    var map = L.map('map').setView([61.4462, 23.854382], 13);

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.{ext}', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        ext: 'png'
    }).addTo(map);

    var markers = [];
    var lines = [];
    var circles = [];

    function createPopupContent(incident) {
        return '<b>' + incident.type.value + '</b><br>' +
            'Detailed Type: ' + (incident.detailedType ? incident.detailedType.value : 'N/A') + '<br>' +
            'Severity: ' + incident.severity + '<br>' +
            'Start Time: ' + incident.startTime + '<br>' +
            'End Time: ' + (incident.endTime || 'Not specified') + '<br>' +
            'Description: ' + (incident.generalPublicComment || 'No description available') + '<br>' +
            'Source: ' + incident.sourceName + '<br>' +
            '<a href="/incident/details/' + incident.id + '">View Details</a>';
    }

    situationRecords.forEach(function (incident) {
        if (incident.location.line != null && incident.location.line.posList != null) {
            var coordinates = incident.location.line.posList.split(' ').map(Number);
            var latLngs = [];
            for (var i = 0; i < coordinates.length; i += 2) {
                latLngs.push([coordinates[i + 1], coordinates[i]]);
            }

            if (latLngs.length === 2) {
                // For two-point lines, create a circle at the midpoint
                var midPoint = [(latLngs[0][0] + latLngs[1][0]) / 2, (latLngs[0][1] + latLngs[1][1]) / 2];
                var distance = map.distance(latLngs[0], latLngs[1]);
                var circle = L.circle(midPoint, {
                    color: 'red',
                    fillColor: 'pink',
                    fillOpacity: 0.3,
                    weight: 2,
                    opacity: 0.5,
                    radius: distance / 2 // Set the radius to half the distance between points
                }).bindPopup(createPopupContent(incident));
                circles.push(circle);
                circle.addTo(map);
            } else {
                // For lines with more than two points, render as a light solid line
                var polyline = L.polyline(latLngs, {
                    color: 'black',
                    weight: 5,
                    opacity: 1,
                }).bindPopup(createPopupContent(incident));
                lines.push(polyline);
                polyline.addTo(map);
            }
        } else if (incident.location.coordinatesForDisplay != null &&
            incident.location.coordinatesForDisplay.latitude != null &&
            incident.location.coordinatesForDisplay.longitude != null) {
            var marker = L.marker([incident.location.coordinatesForDisplay.latitude, incident.location.coordinatesForDisplay.longitude])
                .bindPopup(createPopupContent(incident));
            markers.push(marker);
            marker.addTo(map);
        }
    });

    var group = L.featureGroup(markers.concat(lines).concat(circles));
    map.fitBounds(group.getBounds(), {padding: [50, 50]});
    /*]]>*/
</script>
</body>
</html>